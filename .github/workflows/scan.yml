name: "Manual: Scan Registry"

on:
  workflow_dispatch:
    inputs:
      registry:
        description: "Registry to scan (requires crawled data in cache)"
        required: true
        type: choice
        options:
          - skills-sh
          - clawhub
          - mcp-registry
          - mcp-so
          - lobehub

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - run: pip install -r requirements.txt

      - name: Restore crawl cache
        uses: actions/cache/restore@v4
        with:
          path: data/${{ inputs.registry }}/
          key: ${{ inputs.registry }}-
          restore-keys: |
            ${{ inputs.registry }}-

      - name: Build Aguara from source
        run: |
          git clone --depth 1 https://github.com/garagon/aguara.git /tmp/aguara-src
          cd /tmp/aguara-src
          go build -o "$GITHUB_WORKSPACE/bin/aguara" ./cmd/aguara/
          "$GITHUB_WORKSPACE/bin/aguara" version

      - name: Scan ${{ inputs.registry }}
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          DATA_DIR="data/${{ inputs.registry }}"
          RESULTS="data/${{ inputs.registry }}-results.json"
          ./bin/aguara scan "$DATA_DIR" --format json > "$RESULTS" 2>/dev/null || true
          python -m scanner.ingest "$RESULTS" --registry "${{ inputs.registry }}"
