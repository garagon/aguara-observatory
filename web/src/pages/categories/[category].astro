---
import Base from "../../layouts/Base.astro";
import ScoreGrade from "../../components/ScoreGrade.astro";
import { listCategoryPages, getCategorySkills } from "../../lib/api";
import { gradeBarColors, registryNames, categoryDescriptions } from "../../lib/constants";

export function getStaticPaths() {
  const categories = listCategoryPages();
  return categories.map((category) => ({ params: { category } }));
}

const { category } = Astro.params;
const data = getCategorySkills(category!);
const base = import.meta.env.BASE_URL;
const displayCategory = category!.replace(/-/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
const catDescription = categoryDescriptions[category!] ?? `AI agent skills with ${displayCategory} security findings.`;

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "CollectionPage",
      "name": `${displayCategory} Findings â€” Aguara Watch`,
      "description": catDescription,
      "url": `https://watch.aguarascan.com/categories/${category}/`,
      ...(data ? { "numberOfItems": data.skill_count } : {}),
    },
    {
      "@type": "BreadcrumbList",
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://watch.aguarascan.com/" },
        { "@type": "ListItem", "position": 2, "name": "Categories", "item": "https://watch.aguarascan.com/categories/" },
        { "@type": "ListItem", "position": 3, "name": displayCategory },
      ],
    },
  ],
};
---

<Base title={`${displayCategory} Findings`} description={catDescription} jsonLd={jsonLd}>
  <div class="mb-8">
    <a href={`${base}categories/`} class="text-sm text-gray-400 hover:text-aguara-400 transition-colors">
      &larr; All Categories
    </a>
  </div>

  <div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">{category}</h1>
    <p class="text-gray-400">
      {data ? `${data.skill_count.toLocaleString()} skills with ${category} findings` : "No data available."}
    </p>
  </div>

  {data && data.skills.length > 0 ? (
    <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white">
          Affected Skills ({data.skills.length.toLocaleString()})
        </h2>
        <input
          type="text"
          id="skill-filter"
          placeholder="Filter skills..."
          class="px-3 py-1.5 bg-gray-800 border border-gray-700 rounded text-base sm:text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:border-aguara-500"
        />
      </div>
      <div class="overflow-x-auto max-h-[600px] overflow-y-auto" id="skills-table-container">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-gray-900">
            <tr class="border-b border-gray-800 text-left text-gray-400">
              <th class="px-6 py-3 font-medium">Skill</th>
              <th class="px-4 py-3 font-medium">Registry</th>
              <th class="px-4 py-3 font-medium text-center">Grade</th>
              <th class="px-4 py-3 font-medium text-right">Score</th>
              <th class="px-4 py-3 font-medium text-right">Findings</th>
              <th class="px-4 py-3 font-medium text-right">Critical</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-800/50" id="skills-tbody">
            {data.skills.map((skill) => {
              const safeSlug = skill.slug.replace(/\//g, "_").replace(/:/g, "_");
              const hasReport = skill.finding_count > 0;
              return (
                <tr class="hover:bg-gray-800/50 transition-colors skill-row" data-name={(skill.name || skill.slug).toLowerCase()}>
                  <td class="px-6 py-2.5">
                    {hasReport ? (
                      <a href={`${base}skills/${skill.registry_id}/${safeSlug}/`} class="text-aguara-400 hover:text-aguara-300 transition-colors">
                        {skill.name || skill.slug}
                      </a>
                    ) : (
                      <span class="text-gray-300">{skill.name || skill.slug}</span>
                    )}
                  </td>
                  <td class="px-4 py-2.5">
                    <a href={`${base}registries/${skill.registry_id}/`} class="text-xs text-gray-500 bg-gray-800 px-2 py-0.5 rounded hover:text-gray-300 transition-colors">
                      {registryNames[skill.registry_id] || skill.registry_id}
                    </a>
                  </td>
                  <td class="px-4 py-2.5 text-center">
                    <span class={`inline-block w-7 text-center font-bold text-sm rounded ${gradeBarColors[skill.grade]} text-white`}>
                      {skill.grade}
                    </span>
                  </td>
                  <td class="px-4 py-2.5 text-right text-gray-300 font-mono">{skill.score}</td>
                  <td class="px-4 py-2.5 text-right text-gray-400">{skill.finding_count || "\u2014"}</td>
                  <td class="px-4 py-2.5 text-right">
                    {skill.critical_count > 0 ? (
                      <span class="text-red-400 font-medium">{skill.critical_count}</span>
                    ) : (
                      <span class="text-gray-600">&mdash;</span>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  ) : (
    <div class="bg-gray-900 border border-gray-800 rounded-xl p-12 text-center">
      <p class="text-gray-400">No data available for this category.</p>
    </div>
  )}

  <script>
    const filterInput = document.getElementById("skill-filter") as HTMLInputElement;
    if (filterInput) {
      filterInput.addEventListener("input", () => {
        const q = filterInput.value.toLowerCase();
        document.querySelectorAll<HTMLElement>(".skill-row").forEach((row) => {
          const name = row.dataset.name ?? "";
          row.style.display = name.includes(q) ? "" : "none";
        });
      });
    }
  </script>
</Base>
