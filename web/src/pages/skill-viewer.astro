---
import Base from "../layouts/Base.astro";
---

<Base title="Loading..." description="Security scan report for an AI agent skill.">
  <!-- Loading skeleton (shown until JS replaces content) -->
  <div id="skill-loading">
    <nav class="mb-6 flex items-center gap-2 text-sm text-gray-500 overflow-hidden">
      <div class="h-4 w-16 bg-gray-800 rounded animate-pulse shrink-0"></div>
      <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
      <div class="h-4 w-20 bg-gray-800 rounded animate-pulse shrink-0"></div>
      <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
      <div class="h-4 w-32 bg-gray-800 rounded animate-pulse min-w-0"></div>
    </nav>
    <div class="flex flex-col sm:flex-row items-start justify-between mb-8 gap-4">
      <div class="flex-1 min-w-0">
        <div class="h-8 w-full max-w-[16rem] bg-gray-800 rounded animate-pulse mb-2"></div>
        <div class="h-4 w-48 max-w-full bg-gray-800 rounded animate-pulse"></div>
      </div>
      <div class="w-16 h-16 bg-gray-800 rounded-lg animate-pulse shrink-0"></div>
    </div>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-8">
      <div class="bg-gray-900/50 border border-gray-800 rounded-xl p-4"><div class="h-4 w-16 bg-gray-800 rounded animate-pulse mb-2"></div><div class="h-4 w-24 bg-gray-800 rounded animate-pulse"></div></div>
      <div class="bg-gray-900/50 border border-gray-800 rounded-xl p-4"><div class="h-4 w-16 bg-gray-800 rounded animate-pulse mb-2"></div><div class="h-4 w-24 bg-gray-800 rounded animate-pulse"></div></div>
      <div class="bg-gray-900/50 border border-gray-800 rounded-xl p-4"><div class="h-4 w-16 bg-gray-800 rounded animate-pulse mb-2"></div><div class="h-4 w-24 bg-gray-800 rounded animate-pulse"></div></div>
      <div class="bg-gray-900/50 border border-gray-800 rounded-xl p-4"><div class="h-4 w-16 bg-gray-800 rounded animate-pulse mb-2"></div><div class="h-4 w-24 bg-gray-800 rounded animate-pulse"></div></div>
    </div>
    <div class="bg-gray-900/50 border border-gray-800 rounded-2xl p-5">
      <div class="h-5 w-32 bg-gray-800 rounded animate-pulse mb-4"></div>
      <div class="space-y-2">
        <div class="h-16 bg-gray-800/30 rounded-xl animate-pulse"></div>
        <div class="h-16 bg-gray-800/30 rounded-xl animate-pulse"></div>
        <div class="h-16 bg-gray-800/30 rounded-xl animate-pulse"></div>
      </div>
    </div>
  </div>

  <!-- Content container (hidden until JS populates it) -->
  <div id="skill-content" style="display:none"></div>

  <script is:inline>
  (function() {
    // --- Constants (replicated from constants.ts) ---
    var gradeColors = {
      A: "bg-emerald-500/20 text-emerald-400 border-emerald-500/40",
      B: "bg-green-500/20 text-green-400 border-green-500/40",
      C: "bg-yellow-500/20 text-yellow-400 border-yellow-500/40",
      D: "bg-orange-500/20 text-orange-400 border-orange-500/40",
      F: "bg-red-500/20 text-red-400 border-red-500/40"
    };
    var severityColors = {
      CRITICAL: "bg-red-500/20 text-red-400 border-red-500/30",
      HIGH: "bg-orange-500/20 text-orange-400 border-orange-500/30",
      MEDIUM: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30",
      LOW: "bg-blue-500/20 text-blue-400 border-blue-500/30",
      INFO: "bg-gray-500/20 text-gray-400 border-gray-500/30"
    };
    var registryNames = {
      "skills-sh": "Skills.sh",
      "clawhub": "ClawHub",
      "mcp-registry": "PulseMCP",
      "mcp-so": "mcp.so",
      "lobehub": "LobeHub"
    };
    var severityRank = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, INFO: 4 };
    var severityOrder = ["CRITICAL", "HIGH", "MEDIUM", "LOW"];

    // --- Helpers ---
    function escHtml(s) {
      if (!s) return "";
      var d = document.createElement("div");
      d.appendChild(document.createTextNode(s));
      return d.innerHTML;
    }

    function formatDate(iso) {
      if (!iso) return "\u2014";
      try {
        return new Date(iso).toLocaleDateString("en-US", {
          year: "numeric", month: "short", day: "numeric"
        });
      } catch(e) { return iso; }
    }

    // --- Parse URL ---
    var match = window.location.pathname.match(/^\/skills\/([^/]+)\/([^/]+)\/?$/);
    if (!match) {
      showError("Invalid URL", "The URL does not match a valid skill path.");
      return;
    }
    var registry = match[1];
    var slug = match[2];
    var regName = registryNames[registry] || registry;

    // --- Fetch & Render ---
    fetch("/api/v1/skills/" + encodeURIComponent(registry) + "/" + encodeURIComponent(slug) + ".json")
      .then(function(res) {
        if (!res.ok) throw new Error(res.status);
        return res.json();
      })
      .then(function(report) { render(report); })
      .catch(function() { showError("Skill Not Found", "No report available for " + escHtml(registry) + "/" + escHtml(slug) + "."); });

    function showError(title, msg) {
      document.title = title + " | Aguara Watch";
      document.getElementById("skill-loading").style.display = "none";
      var el = document.getElementById("skill-content");
      el.style.display = "";
      el.innerHTML =
        '<nav class="mb-6 flex items-center gap-2 text-sm text-gray-500">' +
          '<a href="/registries/" class="hover:text-aguara-400 transition-colors">Registries</a>' +
          '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>' +
          '<span class="text-gray-300">' + escHtml(regName) + '</span>' +
        '</nav>' +
        '<div class="bg-gray-900/50 border border-gray-800 rounded-2xl p-12 text-center">' +
          '<h1 class="text-2xl font-bold text-white mb-4">' + escHtml(title) + '</h1>' +
          '<p class="text-gray-400">' + msg + '</p>' +
        '</div>';
    }

    function render(report) {
      document.title = (report.name || slug) + " | Aguara Watch";

      // Update meta description
      var metaDesc = document.querySelector('meta[name="description"]');
      if (metaDesc) metaDesc.setAttribute("content", "Security scan report for " + (report.name || slug) + " from " + regName + ".");

      // Severity counts
      var sevCounts = {};
      (report.findings || []).forEach(function(f) {
        sevCounts[f.severity] = (sevCounts[f.severity] || 0) + 1;
      });

      // Grade badge
      var gc = gradeColors[report.grade] || gradeColors.C;

      // Build HTML
      var html = "";

      // Breadcrumbs
      html += '<nav class="mb-6 flex items-center gap-2 text-sm text-gray-500 overflow-hidden">' +
        '<a href="/registries/" class="hover:text-aguara-400 transition-colors">Registries</a>' +
        '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>' +
        '<a href="/registries/' + encodeURIComponent(registry) + '/" class="hover:text-aguara-400 transition-colors">' + escHtml(regName) + '</a>' +
        '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>' +
        '<span class="text-gray-300 truncate max-w-[200px]">' + escHtml(report.name || slug) + '</span>' +
        '</nav>';

      // Header
      html += '<div class="flex flex-col sm:flex-row items-start justify-between mb-8 gap-4">' +
        '<div class="flex-1 min-w-0">' +
          '<h1 class="text-xl sm:text-3xl font-bold text-white tracking-tight break-words">' + escHtml(report.name || report.slug) + '</h1>' +
          '<p class="text-xs sm:text-sm text-gray-500 mt-1 font-mono truncate">' + escHtml(report.skill_id) + '</p>';
      if (report.description) {
        html += '<p class="text-sm text-gray-400 mt-2">' + escHtml(report.description) + '</p>';
      }
      if (report.url) {
        html += '<a href="' + escHtml(report.url) + '" class="inline-flex items-center gap-1 text-sm text-aguara-400 hover:text-aguara-300 mt-2 transition-colors" target="_blank" rel="noopener noreferrer">' +
          'View source' +
          '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3" /></svg>' +
          '</a>';
      }
      html += '</div>' +
        '<div class="flex items-center gap-2">' +
          '<div class="w-16 h-16 text-3xl ' + gc + ' rounded-lg border-2 flex items-center justify-center font-bold">' + escHtml(report.grade) + '</div>' +
          '<span class="text-sm text-gray-400">' + report.score + '/100</span>' +
        '</div>' +
        '</div>';

      // Meta cards
      html += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-8">' +
        metaCard("First Seen", formatDate(report.first_seen)) +
        metaCard("Last Scanned", formatDate(report.last_seen)) +
        metaCard("Findings", '<span class="font-bold text-white">' + (report.findings || []).length + '</span>') +
        metaCard("Score", '<span class="font-bold text-white">' + report.score + '/100</span>') +
        '</div>';

      if (report.findings && report.findings.length > 0) {
        // Severity summary
        html += '<div class="flex flex-wrap gap-3 mb-6">';
        severityOrder.forEach(function(sev) {
          var count = sevCounts[sev];
          if (!count) return;
          html += '<div class="flex items-center gap-1.5">' +
            severityBadge(sev) +
            '<span class="text-sm font-mono text-gray-400">' + count + '</span>' +
            '</div>';
        });
        html += '</div>';

        // Findings table
        var sorted = report.findings.slice().sort(function(a, b) {
          return (severityRank[a.severity] != null ? severityRank[a.severity] : 5) -
                 (severityRank[b.severity] != null ? severityRank[b.severity] : 5);
        });

        html += '<div class="bg-gray-900/50 border border-gray-800 rounded-2xl p-5">' +
          '<h2 class="text-base font-semibold text-white mb-4">' +
            'Findings <span class="text-gray-500 font-normal">(' + report.findings.length + ')</span>' +
          '</h2>' +
          '<div class="space-y-2">';

        sorted.forEach(function(f) {
          html += '<div class="border border-gray-800/50 rounded-xl overflow-hidden hover:border-gray-700/50 transition-colors">' +
            '<div class="flex items-center gap-3 px-4 py-2.5 bg-gray-800/20">' +
              severityBadge(f.severity) +
              '<span class="font-mono text-xs text-gray-300">' + escHtml(f.rule_id) + '</span>' +
              '<span class="text-xs text-gray-600 hidden sm:inline">' + escHtml(f.category) + '</span>';
          if (f.line) {
            html += '<span class="text-xs text-gray-600 ml-auto font-mono">L' + f.line + '</span>';
          }
          html += '</div>';
          if (f.matched_text) {
            html += '<div class="px-4 py-2.5 bg-gray-950/30 border-t border-gray-800/30">' +
              '<pre class="text-xs text-gray-400 font-mono whitespace-pre-wrap break-all overflow-x-auto leading-relaxed"><code>' + escHtml(f.matched_text) + '</code></pre>' +
              '</div>';
          }
          if (f.message) {
            html += '<div class="px-4 py-2 border-t border-gray-800/30">' +
              '<p class="text-xs text-gray-500">' + escHtml(f.message) + '</p>' +
              '</div>';
          }
          html += '</div>';
        });

        html += '</div></div>';
      } else {
        // No findings
        html += '<div class="bg-gray-900/50 border border-gray-800 rounded-2xl p-8 text-center">' +
          '<svg class="w-12 h-12 mx-auto mb-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">' +
            '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />' +
          '</svg>' +
          '<h2 class="text-lg font-semibold text-white mb-2">No Security Issues Found</h2>' +
          '<p class="text-sm text-gray-400 max-w-md mx-auto">' +
            'Aguara\'s static analysis detected no security findings in this skill. It scored a perfect 100/100.' +
          '</p>' +
          '</div>';
      }

      document.getElementById("skill-loading").style.display = "none";
      var el = document.getElementById("skill-content");
      el.style.display = "";
      el.innerHTML = html;
    }

    function metaCard(label, value) {
      return '<div class="bg-gray-900/50 border border-gray-800 rounded-xl p-4">' +
        '<p class="text-xs text-gray-500 mb-1">' + label + '</p>' +
        '<p class="text-sm text-gray-300 font-mono">' + value + '</p>' +
        '</div>';
    }

    function severityBadge(sev) {
      var upper = sev.toUpperCase();
      var sc = severityColors[upper] || severityColors.INFO;
      return '<span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium rounded-full border ' + sc + '">' + upper + '</span>';
    }
  })();
  </script>
</Base>
