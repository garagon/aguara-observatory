---
interface Props {
  placeholder?: string;
  size?: "default" | "large";
}

const { placeholder = "Search skills and registries...", size = "default" } = Astro.props;
const base = import.meta.env.BASE_URL;
const inputClass = size === "large"
  ? "w-full pl-11 pr-4 py-3.5 bg-gray-900/80 border border-gray-700/50 rounded-xl text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:border-aguara-500 focus:ring-1 focus:ring-aguara-500/30 transition-all backdrop-blur-sm"
  : "w-full pl-10 pr-4 py-2.5 bg-gray-900 border border-gray-700 rounded-xl text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:border-aguara-500 focus:ring-1 focus:ring-aguara-500/30 transition-all";
---

<div class="relative z-[100]" id="search-container" data-base={base}>
  <div class="relative">
    <svg
      class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      stroke-width="2"
    >
      <circle cx="11" cy="11" r="8" />
      <path d="M21 21l-4.35-4.35" />
    </svg>
    <input
      type="text"
      id="search-input"
      placeholder={placeholder}
      class={inputClass}
      autocomplete="off"
    />
    <kbd class="absolute right-3 top-1/2 -translate-y-1/2 hidden sm:inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[10px] text-gray-600 bg-gray-800 rounded border border-gray-700">
      esc
    </kbd>
  </div>
  <div
    id="search-results"
    class="absolute top-full mt-2 left-0 right-0 bg-gray-900 border border-gray-700/50 rounded-xl shadow-2xl shadow-black/40 max-h-80 overflow-y-auto hidden z-[100]"
  >
  </div>
</div>

<script>
  import Fuse from "fuse.js";

  const container = document.getElementById("search-container");
  const base = container?.dataset.base ?? "/aguara-observatory/";

  interface SearchItem {
    type: "skill" | "registry";
    name: string;
    slug: string;
    registry: string;
    score: number;
    grade: string;
    findings: number;
  }

  const gradeColorMap: Record<string, string> = {
    A: "bg-emerald-500",
    B: "bg-green-500",
    C: "bg-yellow-500",
    D: "bg-orange-500",
    F: "bg-red-500",
  };

  async function initSearch() {
    const input = document.getElementById("search-input") as HTMLInputElement;
    const results = document.getElementById("search-results") as HTMLDivElement;
    if (!input || !results) return;

    const items: SearchItem[] = [];

    try {
      const resp = await fetch(`${base}api/v1/registries.json`);
      if (resp.ok) {
        const registries = await resp.json();
        for (const r of registries) {
          items.push({
            type: "registry",
            name: r.name,
            slug: r.id,
            registry: r.id,
            score: Math.round(r.avg_score),
            grade: r.avg_score >= 90 ? "A" : r.avg_score >= 75 ? "B" : r.avg_score >= 50 ? "C" : r.avg_score >= 25 ? "D" : "F",
            findings: 0,
          });
        }
      }
    } catch (e) { console.warn("Failed to load registries for search:", e); }

    try {
      const resp = await fetch(`${base}api/v1/search-index.json`);
      if (resp.ok) {
        const skills = await resp.json();
        for (const s of skills) {
          items.push({
            type: "skill",
            name: s.name,
            slug: s.slug,
            registry: s.registry,
            score: s.score,
            grade: s.grade,
            findings: s.findings,
          });
        }
      }
    } catch (e) { console.warn("Failed to load search index:", e); }

    if (items.length === 0) return;

    const fuse = new Fuse(items, {
      keys: [
        { name: "name", weight: 0.7 },
        { name: "slug", weight: 0.3 },
      ],
      threshold: 0.35,
    });

    let debounceTimer: ReturnType<typeof setTimeout>;

    input.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = input.value.trim();
        if (!query) {
          results.classList.add("hidden");
          return;
        }

        const matches = fuse.search(query, { limit: 10 });
        if (matches.length === 0) {
          results.innerHTML = '<p class="p-4 text-sm text-gray-500 text-center">No results found.</p>';
          results.classList.remove("hidden");
          return;
        }

        // Sort: skills with findings first, then by score descending
        const sorted = matches.sort((a, b) => {
          if (a.item.findings > 0 && b.item.findings === 0) return -1;
          if (a.item.findings === 0 && b.item.findings > 0) return 1;
          return b.item.score - a.item.score;
        });

        results.innerHTML = sorted
          .map(({ item }) => {
            const safeSlug = item.slug.replace(/\//g, "_").replace(/:/g, "_");
            const hasReport = item.findings > 0;
            const href = item.type === "registry"
              ? `${base}registries/${item.registry}/`
              : `${base}skills/${item.registry}/${safeSlug}/`;

            const gradeColor = gradeColorMap[item.grade] ?? "bg-gray-600";
            const findingsLabel = item.type === "registry"
              ? "Registry"
              : hasReport
                ? `${item.registry} · ${item.findings} findings`
                : `${item.registry} · No findings`;
            const nameClass = hasReport ? "text-gray-200" : "text-gray-400";
            const statusIcon = item.type !== "registry" && !hasReport
              ? '<span class="text-emerald-500 text-[10px]">&#10003;</span>'
              : "";

            return `<a href="${href}" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-800/70 transition-colors border-b border-gray-800/30 last:border-0">
              <span class="inline-block w-6 h-6 text-center text-[11px] font-bold rounded-md ${gradeColor} text-white leading-6">${item.grade}</span>
              <div class="flex-1 min-w-0">
                <div class="text-sm ${nameClass} truncate">${item.name}</div>
                <div class="text-[11px] text-gray-500 flex items-center gap-1">${statusIcon}${findingsLabel}</div>
              </div>
              <span class="text-xs text-gray-500 font-mono tabular-nums">${item.score}</span>
            </a>`;
          })
          .join("");
        results.classList.remove("hidden");
      }, 150);
    });

    document.addEventListener("click", (e) => {
      if (!(e.target as HTMLElement).closest("#search-container")) {
        results.classList.add("hidden");
      }
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        results.classList.add("hidden");
        input.blur();
      }
    });
  }

  initSearch();
</script>
