---
/**
 * Client-side search using Fuse.js.
 * Loads search-index.json (all skills) + registries.json for combined search.
 */
interface Props {
  placeholder?: string;
}

const { placeholder = "Search skills and registries..." } = Astro.props;
const base = import.meta.env.BASE_URL;
---

<div class="relative" id="search-container" data-base={base}>
  <div class="relative">
    <svg
      class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      stroke-width="2"
    >
      <circle cx="11" cy="11" r="8" />
      <path d="M21 21l-4.35-4.35" />
    </svg>
    <input
      type="text"
      id="search-input"
      placeholder={placeholder}
      class="w-full pl-10 pr-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:border-aguara-500 focus:ring-1 focus:ring-aguara-500/50 transition-colors"
    />
  </div>
  <div
    id="search-results"
    class="absolute top-full mt-2 left-0 right-0 bg-gray-900 border border-gray-700 rounded-lg shadow-xl max-h-80 overflow-y-auto hidden z-50"
  >
  </div>
</div>

<script>
  import Fuse from "fuse.js";

  const container = document.getElementById("search-container");
  const base = container?.dataset.base ?? "/aguara-observatory/";

  interface SearchItem {
    type: "skill" | "registry";
    name: string;
    slug: string;
    registry: string;
    score: number;
    grade: string;
    findings: number;
  }

  const gradeColorMap: Record<string, string> = {
    A: "bg-emerald-500",
    B: "bg-green-500",
    C: "bg-yellow-500",
    D: "bg-orange-500",
    F: "bg-red-500",
  };

  async function initSearch() {
    const input = document.getElementById("search-input") as HTMLInputElement;
    const results = document.getElementById("search-results") as HTMLDivElement;
    if (!input || !results) return;

    const items: SearchItem[] = [];

    // Load registries
    try {
      const resp = await fetch(`${base}api/v1/registries.json`);
      if (resp.ok) {
        const registries = await resp.json();
        for (const r of registries) {
          items.push({
            type: "registry",
            name: r.name,
            slug: r.id,
            registry: r.id,
            score: Math.round(r.avg_score),
            grade: r.avg_score >= 90 ? "A" : r.avg_score >= 75 ? "B" : r.avg_score >= 50 ? "C" : r.avg_score >= 25 ? "D" : "F",
            findings: 0,
          });
        }
      }
    } catch (e) { console.warn("Failed to load registries for search:", e); }

    // Load skill search index
    try {
      const resp = await fetch(`${base}api/v1/search-index.json`);
      if (resp.ok) {
        const skills = await resp.json();
        for (const s of skills) {
          items.push({
            type: "skill",
            name: s.name,
            slug: s.slug,
            registry: s.registry,
            score: s.score,
            grade: s.grade,
            findings: s.findings,
          });
        }
      }
    } catch (e) { console.warn("Failed to load search index:", e); }

    if (items.length === 0) return;

    const fuse = new Fuse(items, {
      keys: [
        { name: "name", weight: 0.7 },
        { name: "slug", weight: 0.3 },
      ],
      threshold: 0.35,
    });

    let debounceTimer: ReturnType<typeof setTimeout>;

    input.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = input.value.trim();
        if (!query) {
          results.classList.add("hidden");
          return;
        }

        const matches = fuse.search(query, { limit: 12 });
        if (matches.length === 0) {
          results.innerHTML = '<p class="p-4 text-sm text-gray-500">No results found.</p>';
          results.classList.remove("hidden");
          return;
        }

        results.innerHTML = matches
          .map(({ item }) => {
            const safeSlug = item.slug.replace(/\//g, "_").replace(/:/g, "_");
            const href = item.type === "registry"
              ? `${base}registries/${item.registry}/`
              : item.findings > 0
                ? `${base}skills/${item.registry}/${safeSlug}/`
                : `${base}registries/${item.registry}/`;

            const gradeColor = gradeColorMap[item.grade] ?? "bg-gray-600";
            const typeLabel = item.type === "registry" ? "Registry" : item.registry;

            return `<a href="${href}" class="flex items-center gap-3 p-3 hover:bg-gray-800 transition-colors border-b border-gray-800/50 last:border-0">
              <span class="inline-block w-6 text-center text-xs font-bold rounded ${gradeColor} text-white py-0.5">${item.grade}</span>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-gray-200 truncate">${item.name}</div>
                <div class="text-xs text-gray-500">${typeLabel}${item.findings > 0 ? ` Â· ${item.findings} findings` : ""}</div>
              </div>
              <span class="text-xs text-gray-500 tabular-nums">${item.score}/100</span>
            </a>`;
          })
          .join("");
        results.classList.remove("hidden");
      }, 150);
    });

    // Close on outside click
    document.addEventListener("click", (e) => {
      if (!(e.target as HTMLElement).closest("#search-container")) {
        results.classList.add("hidden");
      }
    });

    // Close on Escape
    input.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        results.classList.add("hidden");
        input.blur();
      }
    });
  }

  initSearch();
</script>
